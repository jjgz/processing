// DOM-IGNORE-BEGIN
/*******************************************************************************
Copyright (c) 2013-2014 released Microchip Technology Inc.  All rights reserved.

Microchip licenses to you the right to use, modify, copy and distribute
Software only when embedded on a Microchip microcontroller or digital signal
controller that is integrated into your product or third party product
(pursuant to the sublicense terms in the accompanying license agreement).

You should refer to the license agreement accompanying this Software for
additional information regarding your rights and obligations.

SOFTWARE AND DOCUMENTATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF
MERCHANTABILITY, TITLE, NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE.
IN NO EVENT SHALL MICROCHIP OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER
CONTRACT, NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR
OTHER LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE OR
CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT OF
SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
(INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
 *******************************************************************************/
// DOM-IGNORE-END
#include <math.h>
#include "processing.h"
#include "network/send.h"
#include "debug.h"
#include "int_adc.h"
#include "world/world.h"

typedef enum {
    AS_WAIT_INIT,
    AS_SCANNING,
    AS_SUPPLY_GRID,
} AState;

QueueHandle_t processing_queue;
AState astate;

float distance_lookup[1024] = {1.08849123127, 1.0848631003716744, 1.0812450280718529, 1.0776369993230699, 1.0740389990778592, 1.0704510122887545, 1.0668730239082898, 1.063305018888999, 1.059746982183416, 1.0561988987440745, 1.0526607535235089, 1.0491325314742523, 1.0456142175488394, 1.0421057966998035, 1.038607253879679, 1.0351185740409994, 1.0316397421362986, 1.0281707431181106, 1.0247115619389693, 1.0212621835514086, 1.0178225929079625, 1.0143927749611645, 1.010972714663549, 1.0075623969676495, 1.004161806826, 1.0007709291911346, 0.997389749015587, 0.9940182512518908, 0.9906564208525804, 0.9873042427701896, 0.9839617019572519, 0.9806287833663015, 0.9773054719498725, 0.9739917526604984, 0.9706876104507133, 0.9673930302730508, 0.9641079970800454, 0.9608324958242304, 0.9575665114581399, 0.9543100289343078, 0.9510630332052681, 0.9478255092235542, 0.9445974419417008, 0.9413788163122413, 0.9381696172877094, 0.9349698298206395, 0.931779438863565, 0.9285984293690203, 0.9254267862895388, 0.9222644945776547, 0.9191115391859016, 0.9159679050668137, 0.9128335771729248, 0.9097085404567689, 0.9065927798708795, 0.9034862803677909, 0.9003890269000369, 0.8973010044201511, 0.8942221978806678, 0.8911525922341207, 0.8880921724330437, 0.8850409234299705, 0.8819988301774355, 0.8789658776279722, 0.8759420507341144, 0.8729273344483962, 0.8699217137233515, 0.8669251735115142, 0.8639376987654178, 0.860959274437597, 0.857989885480585, 0.8550295168469161, 0.8520781534891235, 0.8491357803597419, 0.8462023824113049, 0.8432779445963463, 0.8403624518674001, 0.837455889177, 0.8345582414776802, 0.8316694937219743, 0.8287896308624164, 0.8259186378515404, 0.82305649964188, 0.8202032011859691, 0.8173587274363419, 0.8145230633455319, 0.8116961938660732, 0.8088781039504997, 0.8060687785513454, 0.8032682026211436, 0.800476361112429, 0.7976932389777349, 0.7949188211695957, 0.7921530926405448, 0.7893960383431161, 0.786647643229844, 0.7839078922532621, 0.781176770365904, 0.7784542625203039, 0.775740353668996, 0.7730350287645135, 0.7703382727593906, 0.7676500706061612, 0.7649704072573595, 0.762299267665519, 0.7596366367831736, 0.7569824995628572, 0.7543368409571038, 0.7516996459184474, 0.7490708993994217, 0.7464505863525608, 0.7438386917303981, 0.7412352004854682, 0.7386400975703042, 0.7360533679374408, 0.7334749965394113, 0.7309049683287498, 0.7283432682579902, 0.7257898812796664, 0.7232447923463121, 0.7207079864104616, 0.7181794484246485, 0.7156591633414066, 0.7131471161132702, 0.7106432916927725, 0.7081476750324482, 0.7056602510848305, 0.7031810048024538, 0.7007099211378518, 0.6982469850435582, 0.6957921814721071, 0.6933454953760325, 0.690906911707868, 0.6884764154201476, 0.6860539914654055, 0.683639624796175, 0.6812333003649904, 0.6788350031243856, 0.6764447180268942, 0.6740624300250506, 0.671688124071388, 0.669321785118441, 0.6669633981187428, 0.6646129480248281, 0.66227041978923, 0.6599357983644828, 0.6576090687031203, 0.6552902157576763, 0.6529792244806851, 0.6506760798246801, 0.6483807667421954, 0.6460932701857648, 0.6438135751079225, 0.6415416664612018, 0.6392775291981373, 0.6370211482712623, 0.6347725086331111, 0.6325315952362172, 0.6302983930331149, 0.6280728869763379, 0.6258550620184199, 0.623644903111895, 0.6214423952092972, 0.6192475232631603, 0.6170602722260181, 0.6148806270504045, 0.6127085726888536, 0.6105440940938989, 0.6083871762180746, 0.6062378040139145, 0.6040959624339526, 0.6019616364307225, 0.5998348109567584, 0.5977154709645941, 0.5956036014067634, 0.5934991872358002, 0.5914022134042386, 0.5893126648646122, 0.5872305265694551, 0.585155783471301, 0.5830884205226841, 0.581028422676138, 0.5789757748841966, 0.576930462099394, 0.574892469274264, 0.5728617813613405, 0.5708383833131572, 0.5688222600822482, 0.5668133966211472, 0.5648117778823883, 0.5628173888185055, 0.5608302143820323, 0.558850239525503, 0.5568774492014511, 0.5549118283624107, 0.5529533619609157, 0.5510020349495002, 0.5490578322806975, 0.5471207389070419, 0.5451907397810674, 0.5432678198553076, 0.5413519640822967, 0.539443157414568, 0.5375413848046562, 0.5356466312050947, 0.5337588815684173, 0.5318781208471584, 0.5300043339938514, 0.5281375059610302, 0.5262776217012289, 0.5244246661669815, 0.5225786243108216, 0.5207394810852832, 0.5189072214429001, 0.5170818303362066, 0.5152632927177361, 0.5134515935400226, 0.5116467177556002, 0.5098486503170028, 0.5080573761767637, 0.5062728802874177, 0.5044951476014982, 0.5027241630715388, 0.500959911650074, 0.49920237828963726, 0.4974515479427627, 0.4957074055619841, 0.4939699360998353, 0.4922391245088503, 0.4905149557415631, 0.4887974147505072, 0.487086486488217, 0.48538215590722616, 0.48368440796006823, 0.48199322759927765, 0.4803085997773881, 0.4786305094469333, 0.4769589415604474, 0.4752938810704641, 0.4736353129295174, 0.47198322209014126, 0.47033759350486926, 0.4686984121262357, 0.46706566290677426, 0.46543933079901867, 0.4638194007555031, 0.4622058577287615, 0.4605986866713273, 0.45899787253573493, 0.45740340027451803, 0.45581525484021024, 0.45423342118534593, 0.45265788426245857, 0.45108862902408253, 0.44952564042275134, 0.4479689034109987, 0.44641840294135915, 0.4448741239663661, 0.4433360514385535, 0.44180417031045527, 0.4402784655346054, 0.43875892206353756, 0.43724552484978585, 0.4357382588458841, 0.43423710900436613, 0.43274206027776607, 0.43125309761861746, 0.4297702059794544, 0.4282933703128108, 0.4268225755712204, 0.4253578067072173, 0.4238990486733353, 0.4224462864221081, 0.42099950490606985, 0.41955868907775445, 0.41812382388969543, 0.4166948942944272, 0.41527188524448316, 0.4138547816923976, 0.41244356859070436, 0.4110382308919369, 0.40963875354862966, 0.4082451215133163, 0.4068573197385307, 0.4054753331768066, 0.40409914678067826, 0.4027287455026792, 0.4013641142953436, 0.400005238111205, 0.3986521019027977, 0.39730469062265544, 0.3959629892233119, 0.39462698265730134, 0.39329665587715734, 0.3919719938354139, 0.39065298148460503, 0.38933960377726445, 0.388031845665926, 0.3867296921031238, 0.3854331280413917, 0.38414213843326334, 0.3828567082312729, 0.38157682238795404, 0.3803024658558408, 0.3790336235874672, 0.3777702805353667, 0.37651242165207366, 0.3752600318901218, 0.3740130962020448, 0.37277159954037686, 0.3715355268576518, 0.3703048631064032, 0.3690795932391655, 0.36785970220847214, 0.36664517496685706, 0.3654359964668545, 0.3642321516609978, 0.36303362550182144, 0.36184040294185893, 0.3606524689336442, 0.3594698084297114, 0.3582924063825941, 0.3571202477448262, 0.3559533174689418, 0.3547916005074748, 0.3536350818129588, 0.35248374633792806, 0.3513375790349161, 0.3501965648564571, 0.3490606887550849, 0.34792993568333314, 0.34680429059373613, 0.34568373843882744, 0.344568264171141, 0.34345785274321083, 0.3423524891075709, 0.3412521582167548, 0.3401568450232966, 0.3390665344797302, 0.33798121153858934, 0.33690086115240814, 0.33582546827372023, 0.33475501785505984, 0.33368949484896065, 0.33262888420795644, 0.3315731708845813, 0.33052233983136925, 0.32947637600085367, 0.32843526434556897, 0.32739898981804877, 0.3263675373708269, 0.3253408919564376, 0.3243190385274145, 0.32330196203629136, 0.32228964743560234, 0.32128207967788125, 0.32027924371566197, 0.31928112450147844, 0.3182877069878643, 0.3172989761273538, 0.31631491687248064, 0.31533551417577865, 0.31436075298978194, 0.31339061826702436, 0.3124250949600394, 0.31146416802136145, 0.31050782240352415, 0.3095560430590614, 0.3086088149405074, 0.3076661230003956, 0.3067279521912601, 0.3057942874656346, 0.30486511377605335, 0.30394041607505007, 0.3030201793151587, 0.3021043884489129, 0.3011930284288465, 0.3002860842074939, 0.2993835407373887, 0.29848538297106475, 0.297591595861056, 0.2967021643598965, 0.2958170734201196, 0.29493630799425974, 0.2940598530348506, 0.29318769349442614, 0.2923198143255202, 0.29145620048066645, 0.2905968369123993, 0.2897417085732524, 0.28889080041575954, 0.2880440973924546, 0.28720158445587146, 0.28636324655854406, 0.28552906865300637, 0.2846990356917924, 0.28387313262743574, 0.28305134441247054, 0.2822336559994302, 0.28142005234084916, 0.28061051838926127, 0.2798050390972001, 0.27900359941719993, 0.27820618430179417, 0.27741277870351694, 0.2766233675749024, 0.27583793586848415, 0.2750564685367961, 0.2742789505323722, 0.27350536680774634, 0.27273570231545213, 0.271969942008024, 0.27120807083799564, 0.27045007375790076, 0.26969593572027334, 0.26894564167764695, 0.26819917658255626, 0.2674565253875346, 0.26671767304511607, 0.2659826045078344, 0.2652513047282236, 0.26452375865881717, 0.26379995125214956, 0.26307986746075457, 0.2623634922371659, 0.2616508105339174, 0.26094180730354294, 0.2602364674985769, 0.2595347760715527, 0.2588367179750043, 0.25814227816146557, 0.25745144158347055, 0.2567641931935527, 0.2560805179442466, 0.25540040078808574, 0.2547238266776042, 0.25405078056533564, 0.2533812474038137, 0.2527152121455728, 0.25205265974314683, 0.2513935751490695, 0.25073794331587473, 0.2500857491960962, 0.2494369777422679, 0.24879161390692398, 0.24814964264259812, 0.24751104890182427, 0.24687581763713629, 0.24624393380106802, 0.24561538234615315, 0.24499014822492624, 0.24436821638992054, 0.24374957179367046, 0.24313419938870934, 0.24252208412757115, 0.24191321096279017, 0.2413075648469002, 0.24070513073243494, 0.24010589357192844, 0.2395098383179143, 0.23891694992292656, 0.23832721333949927, 0.2377406135201663, 0.2371571354174615, 0.23657676398391872, 0.23599948417207148, 0.23542528093445425, 0.23485413922360082, 0.23428604399204508, 0.2337209801923207, 0.2331589327769617, 0.23259988669850154, 0.23204382690947492, 0.23149073836241546, 0.23094060600985672, 0.23039341480433284, 0.2298491496983775, 0.22930779564452497, 0.2287693375953089, 0.22823376050326327, 0.2277010493209219, 0.2271711890008186, 0.22664416449548713, 0.22611996075746202, 0.22559856273927656, 0.2250799553934649, 0.22456412367256093, 0.22405105252909796, 0.22354072691561094, 0.223033131784633, 0.22252825208869836, 0.2220260727803408, 0.2215265788120941, 0.22102975513649212, 0.22053558670606901, 0.22004405847335862, 0.2195551553908947, 0.2190688624112113, 0.2185851644868421, 0.21810404657032093, 0.2176254936141821, 0.21714949057095917, 0.21667602239318617, 0.21620507403339692, 0.21573663044412497, 0.2152706765779049, 0.21480719738727028, 0.21434617782475504, 0.213887602842893, 0.21343145739421793, 0.2129777264312637, 0.21252639490656455, 0.21207744777265433, 0.21163086998206673, 0.21118664648733557, 0.2107447622409949, 0.21030520219557855, 0.20986795130362032, 0.2094329945176545, 0.20900031679021464, 0.20856990307383466, 0.208141738321048, 0.20771580748438975, 0.20729209551639283, 0.20687058736959119, 0.2064512679965193, 0.20603412234971016, 0.2056191353816982, 0.20520629204501772, 0.204795577292202, 0.20438697607578513, 0.20398047334830072, 0.20357605406228302, 0.20317370317026562, 0.20277340562478302, 0.2023751463783685, 0.20197891038355614, 0.20158468259288, 0.20119244795887326, 0.20080219143407108, 0.20041389797100603, 0.20002755252221308, 0.19964314004022538, 0.19926064547757685, 0.19888005378680176, 0.19850134992043425, 0.1981245188310075, 0.19774954547105555, 0.19737641479311285, 0.19700511174971244, 0.1966356212933887, 0.19626792837667587, 0.19590201795210727, 0.19553787497221706, 0.19517548438953855, 0.19481483115660644, 0.1944559002259545, 0.1940986765501165, 0.19374314508162604, 0.19338929077301728, 0.19303709857682388, 0.19268655344558003, 0.1923376403318196, 0.19199034418807642, 0.19164464996688452, 0.19130054262077703, 0.1909580071022889, 0.19061702836395325, 0.19027759135830444, 0.18993968103787626, 0.1896032823552026, 0.18926838026281675, 0.18893495971325358, 0.18860300565904656, 0.18827250305272972, 0.18794343684683654, 0.18761579199390063, 0.18728955344645717, 0.18696470615703903, 0.18664123507818042, 0.1863191251624153, 0.18599836136227724, 0.18567892863030008, 0.1853608119190183, 0.1850439961809653, 0.18472846636867515, 0.1844142074346819, 0.18410120433151894, 0.1837894420117206, 0.1834789054278204, 0.1831695795323529, 0.18286144927785136, 0.18255449961684989, 0.18224871550188226, 0.18194408188548244, 0.18164058372018452, 0.18133820595852224, 0.1810369335530293, 0.1807367514562398, 0.18043764462068745, 0.18013959799890666, 0.17984259654343066, 0.17954662520679376, 0.1792516689415295, 0.17895771270017205, 0.17866474143525538, 0.17837274009931295, 0.17808169364487933, 0.17779158702448783, 0.17750240519067265, 0.177214133095967, 0.17692675569290575, 0.17664025793402244, 0.17635462477185096, 0.176069841158925, 0.17578589204777828, 0.1755027623909454, 0.17522043714095972, 0.1749389012503553, 0.174658139671666, 0.17437813735742555, 0.17409887926016773, 0.17382035033242718, 0.17354253552673704, 0.17326541979563184, 0.1729889880916448, 0.17271322536731, 0.17243811657516125, 0.1721636466677329, 0.17188980059755873, 0.17161656331717254, 0.1713439197791079, 0.17107185493589855, 0.17080035374007932, 0.17052940114418347, 0.17025898210074497, 0.16998908156229756, 0.16971968448137567, 0.16945077581051235, 0.169182340502242, 0.16891436350909886, 0.16864682978361617, 0.16837972427832795, 0.16811303194576827, 0.16784673773847103, 0.1675808266089702, 0.16731528350979924, 0.16705009339349255, 0.16678524121258373, 0.16652071191960666, 0.16625649046709529, 0.16599256180758368, 0.1657289108936057, 0.16546552267769485, 0.16520238211238522, 0.16493947415021107, 0.16467678374370595, 0.16441429584540376, 0.16415199540783837, 0.1638898673835436, 0.16362789672505318, 0.16336606838490172, 0.1631043673156228, 0.16284277846974995, 0.16258128679981734, 0.162319877258359, 0.16205853479790802, 0.16179724437099946, 0.1615359909301666, 0.1612747594279433, 0.16101353481686387, 0.16075230204946125, 0.16049104607827022, 0.16022975185582464, 0.15996840433465778, 0.15970698846730452, 0.15944548920629725, 0.15918389150417103, 0.15892218031346003, 0.15866034058669687, 0.1583983572764168, 0.15813621533515262, 0.15787389971543864, 0.1576113953698093, 0.15734868725079734, 0.15708576031093816, 0.15682259950276375, 0.1565591897788099, 0.15629551609160897, 0.15603156339369542, 0.15576731663760385, 0.15550276077586694, 0.15523788076102005, 0.15497266154559522, 0.1547070880821274, 0.15444114532315087, 0.1541748182211989, 0.1539080917288058, 0.1536409507985044, 0.15337338038282972, 0.15310536543431566, 0.15283689090549502, 0.15256794174890345, 0.15229850291707303, 0.15202855936253912, 0.15175809603783405, 0.15148709789549308, 0.15121554988804986, 0.15094343696803728, 0.15067074408799108, 0.15039745620044306, 0.15012355825792814, 0.14984903521298087, 0.14957387201813385, 0.14929805362592222, 0.14902156498887836, 0.1487443910595372, 0.14846651679043305, 0.1481879271340987, 0.14790860704306907, 0.14762854146987686, 0.14734771536705676, 0.14706611368714298, 0.14678372138266832, 0.14650052340616812, 0.14621650471017492, 0.1459316502472235, 0.1456459449698469, 0.14535937383057937, 0.14507192178195574, 0.14478357377650813, 0.14449431476677219, 0.144204129705281, 0.14391300354456799, 0.1436209212371675, 0.1433278677356138, 0.1430338279924409, 0.14273878696018122, 0.14244272959137033, 0.14214564083854156, 0.14184750565422818, 0.14154830899096474, 0.141248035801285, 0.14094667103772296, 0.14064419965281247, 0.1403406065990874, 0.14003587682908103, 0.13972999529532795, 0.1394229469503626, 0.13911471674671694, 0.13880528963692748, 0.13849465057352572, 0.13818278450904642, 0.13786967639602446, 0.13755531118699224, 0.13723967383448452, 0.13692274929103496, 0.13660452250917704, 0.1362849784414456, 0.13596410204037412, 0.13564187825849583, 0.13531829204834533, 0.13499332836245692, 0.13466697215336287, 0.1343392083735988, 0.13401002197569797, 0.13367939791219366, 0.13334732113562092, 0.13301377659851213, 0.13267874925340262, 0.13234222405282578, 0.1320041859493151, 0.13166461989540543, 0.13132351084362962, 0.13098084374652208, 0.13063660355661716, 0.13029077522644722, 0.1299433437085485, 0.12959429395545236, 0.12924361091969452, 0.12889127955380775, 0.128537284810326, 0.12818161164178463, 0.1278242450007156, 0.1274651698396542, 0.12710437111113387, 0.12674183376768805, 0.126377542761851, 0.12601148304615664, 0.1256436395731391, 0.12527399729533192, 0.12490254116526871, 0.12452925613548434, 0.12415412715851164, 0.12377713918688552, 0.12339827717313835, 0.12301752606980547, 0.12263487082942046, 0.12225029640451657, 0.12186378774762871, 0.12147532981128986, 0.12108490754803417, 0.12069250591039578, 0.120298109850908, 0.11990170432210628, 0.11950327427652244, 0.11910280466669121, 0.11870028044514676, 0.11829568656442278, 0.11788900797705347, 0.11748022963557236, 0.11706933649251333, 0.11665631350041009, 0.11624114561179692, 0.11582381777920758, 0.11540431495517606, 0.11498262209223606, 0.1145587241429213, 0.1141326060597664, 0.11370425279530447, 0.1132736493020695, 0.11284078053259672, 0.11240563143941744, 0.11196818697506837, 0.11152843209208112, 0.11108635174299031, 0.11064193088033084, 0.11019515445663464, 0.10974600742443807, 0.10929447473627281, 0.10884054134467343, 0.10838419220217514, 0.10792541226130987, 0.10746418647461253, 0.10700049979461683, 0.10653433717385617, 0.10606568356486605, 0.10559452392017812, 0.10512084319232846, 0.10464462633384901, 0.10416585829727554, 0.10368452403513971, 0.1032006084999773, 0.10271409664432171, 0.10222497342070609, 0.10173322378166562, 0.10123883267973283, 0.10074178506744201, 0.1002420658973284, 0.09973966012192388, 0.09923455269376398, 0.09872672856538182, 0.09821617268931021, 0.09770287001808553, 0.09718680550423972, 0.09666796410030738, 0.09614633075882253, 0.09562189043231858, 0.09509462807332955, 0.09456452863438854, 0.09403157706803195, 0.0934957583267914, 0.0929570573632015, 0.09241545912979568, 0.09187094857910824, 0.09132351066367378, 0.09077313033602483, 0.09021979254869687, 0.08966348225422155, 0.08910418440513408, 0.08854188395396992, 0.08797656585326014, 0.08740821505554022, 0.08683681651334299, 0.08626235517920365, 0.0856848160056553, 0.08510418394523168, 0.08452044395046827, 0.08393358097389612, 0.0833435799680519, 0.08275042588546784, 0.08215410367867797, 0.08155459830021745, 0.08095189470261825, 0.08034597783841585, 0.07973683266014307, 0.07912444412033452, 0.0785087971715239, 0.07788987676624494, 0.07726766785703164, 0.07664215539641771, 0.07601332433693687, 0.07538115963112432, 0.07474564623151199, 0.07410676909063567, 0.07346451316102759, 0.07281886339522295, 0.07216980474575456, 0.07151732216515674, 0.0708614006059644, 0.07020202502070973, 0.06953918036192767, 0.06887285158215133, 0.06820302363391591, 0.06752968146975451, 0.06685281004219967, 0.06617239430378807, 0.06548841920705166, 0.06480086970452442, 0.06410973074874127, 0.06341498729223473, 0.06271662428754028, 0.06201462668719048, 0.06130897944371991, 0.06059966750966228, 0.059886675837550724, 0.059169989379921316, 0.058449593089305404, 0.05772547191823819, 0.05699761081925338, 0.05626599474488468, 0.05553060864766641, 0.05479143748013168, 0.0540484661948154, 0.053301679744250686, 0.052551063080971544, 0.05179660115751288, 0.051038278926406624, 0.050276081340188856, 0.04950999335139153, 0.04873999991254922, 0.04796608597619686, 0.04718823649486606, 0.0464064364210935, 0.04562067070741054, 0.04483092430635296, 0.04403718217045417, 0.043239429252247004, 0.04243765050426694, 0.041631830879045935, 0.040821955329120356, 0.040008008807021544, 0.0391899762652847, 0.038367842656444426, 0.03754159293303295, 0.03671121204758606, 0.035876684952636, 0.035037996600716464, 0.03419513194436326, 0.0333480759361083, 0.0324968135284871, 0.03164132967403247, 0.030781609325278427, 0.02991763743475927, 0.02904939895500872, 0.028176878838560782, 0.027300062037948578, 0.026418933505707305, 0.025533478194369488, 0.024643681056469437, 0.023749527044542345, 0.02285100111112015, 0.021948088208738045, 0.02104077328992915, 0.020129041307227775, 0.019212877213168517, 0.01829226596028391, 0.01736719250110855, 0.016437641788175864, 0.015503598774019856, 0.014565048411175717, 0.013621975652175392, 0.01267436544955466, 0.011722202755845169, 0.010765472523582106, 0.009804159705300672, 0.008838249253532207, 0.0078677261208125, 0.006892575259673487, 0.005912781622651844, 0.004928330162278618, 0.003939205831089005, 0.0029453935816181986, 0.0019468783663978393, 0.000943645137962826, -0.00006432115115312801, -0.0010770355484157168, -0.0020945131012912264, -0.003116768857246535, -0.004143817863746449, -0.005175675168258143, -0.0062123558182473095, -0.007253874861179941, -0.008300247344522322, -0.009351488315740147, -0.010407612822300592, -0.01146863591166846, -0.012534572631310928, -0.013605438028693392, -0.014681247151282438, -0.015762015046543457, -0.016847756761943337, -0.01793848734494806, -0.019034221843023915, -0.020134975303635706, -0.021240762774251503, -0.02235159930233551, -0.0234674999353555, -0.02458847972077687, -0.025714553706065013, -0.026845736938687408, -0.02798204446610856, -0.02912349133579653, -0.03027009259521583, -0.031421863291833045, -0.03257881847311475, -0.03374097318652606, -0.03490834247953443, -0.036080941399604965, -0.037258784994203965, -0.038441888310798, -0.039630266396852167, -0.04082393429983395, -0.042022907067207856};

void processing_add_recvmsg(NRMessage *message) {
    PRMessage pr_message;
    pr_message.type = PR_NR;
    pr_message.data.nr_message = *message;
    xQueueSendToBack(processing_queue, &pr_message, portMAX_DELAY);
}

void processing_add_message(PRMessage *message) {
    BaseType_t higher_priority_task_woken = pdFALSE;
    // Attempt add the buffer from the isr to the queue.
    if (xQueueSendToBackFromISR(processing_queue, message, &higher_priority_task_woken)) {
        // If a higher priority task was waiting for something on the queue, switch to it.
        portEND_SWITCHING_ISR(higher_priority_task_woken);
    // We didn't receive a buffer.
    } else {
        // Indicate on LD4 that we lost a packet.
        // NOTE: LD4 conflicts with SDA2 (I2C).
        SYS_PORTS_PinWrite(0, PORT_CHANNEL_A, PORTS_BIT_POS_3, 1);
    }
}

void PROCESSING_Initialize() {
    astate = AS_WAIT_INIT;
    processing_queue = xQueueCreate(PROCESSING_QUEUE_LEN, sizeof(PRMessage));
    
    DRV_ADC_Open();
    DRV_TMR0_Start();
}

uint8_t grid[128 * 128];

float clampf(float val, float mini, float maxi)  {
    return min(maxi, max(mini, val));
}

void PROCESSING_Tasks() {
    PRMessage recv_message;
    NSMessage send_message;
    // Create netstats message.
    NSMessage netstats_message;
    netstats_message.type = NS_NETSTATS;
    MSGNetstats *netstats = &netstats_message.data.netstats;
    netstats->numGoodMessagesRecved = 0;
    netstats->numCommErrors = 0;
    netstats->numJSONRequestsRecved = 0;
    netstats->numJSONResponsesRecved = 0;
    netstats->numJSONRequestsSent = 0;
    netstats->numJSONResponsesSent = 0;
    
    unsigned i;
    int x, y;
    for (i = 0; i < 128*128; i++)
        grid[i] = i % 100;

    while (1) {
        // We responded to a request, so we increase the responses sent.
        xQueueReceive(processing_queue, &recv_message, portMAX_DELAY);
        
        switch (recv_message.type) {
            case PR_NR:{
                NRMessage *nr_message = &recv_message.data.nr_message;
                 switch (nr_message->type) {
                    case NR_QUERY_STATS: {
                        netstats->numGoodMessagesRecved++;
                        netstats->numJSONRequestsRecved++;
                        network_send_add_message(&netstats_message);

                        // We responded to a request, so we increase the responses sent.
                        netstats->numJSONResponsesSent++;
                    } break;
                     case NR_GD_REQ_PING:
                     {
                         send_message.type = NS_GD_PING;
                        network_send_add_message(&send_message);
                     } break;
                    case NR_INVALID_ERROR:
                    {
                        netstats->numCommErrors++;
                    } break;
                    case NR_REQ_NAME:
                    {
                        send_message.type = NS_SEND_NAME_GEO;
                        network_send_add_message(&send_message);
                    } break;
                    case NR_GD_FINISH:
                    {
                        astate = AS_SUPPLY_GRID;
                        send_message.type = NS_DEBUG_GEORDON_STR;
                        send_message.data.dbstr = "Got finish";
                        network_send_add_message(&send_message);
                    } break;
                    case NR_GD_ALIGNED:
                    {
                        world_rover_aligned();
                        send_message.type = NS_DEBUG_GEORDON_STR;
                        send_message.data.dbstr = "Got aligned";
                        network_send_add_message(&send_message);
                    } break;
                     case NR_GD_BUILD: {
                         // Initialize the grid to 99.
                         for (i = 0; i < 128 * 128; i++) {
                             grid[i] = 99;
                         }
                         VariancePoint *points;
                         unsigned clear_points = world_retrieve_clear_points(&points);
                         for (i = 0; i < clear_points; i++) {
                             for (x = -1; x <= 1; x++) {
                                 for (y = -1; y <= 1; y++) {
                                     float xf = points[i].p.x + x * 5.0 / 128.0;
                                     float yf = points[i].p.y + y * 5.0 / 128.0;
                                     grid[(unsigned)(clampf(xf, 0.0, 4.9999) * 128.0 / 5.0) + (unsigned)(clampf(yf, 0.0, 4.9999) * 128.0 / 5.0) * 128] = 0;
                                 }
                             }
                         }
                         send_message.type = NS_DEBUG_GEORDON_STR;
                        send_message.data.dbstr = "Got build";
                        network_send_add_message(&send_message);
                     } break;
                    case NR_MOVEMENT:
                    {
                        OrientPoint op = {{{nr_message->data.movement.x, nr_message->data.movement.y},
                                nr_message->data.movement.v, {0, 0, 0, 0}}, nr_message->data.movement.angle, nr_message->data.movement.av};
                        world_update_movement(op);
                    } break;
                    case NR_INITIALIZE:
                    {
                        astate = AS_SCANNING;
                        OrientPoint ra = {{{nr_message->data.initialization.ra.x, nr_message->data.initialization.ra.y}, 0.0f, {0, 0, 0, 0}}, 0.0f, 0.0f};
                        world_init(ra, nr_message->data.initialization.nt,
                                3.0f, (AbsolutePoint*)nr_message->data.initialization.points,
                                nr_message->data.initialization.nb);
                        // Send initialization confirmation after performing init.
                        send_message.type = NS_DEBUG_GEORDON_STR;
                        send_message.data.dbstr = "Got initialize";
                        network_send_add_message(&send_message);
                    } break;
                    case NR_GD_REQ_HALF_ROW:
                    {
                        for (i = 0; i < 64; i++)
                            send_message.data.w_array[i] = grid[recv_message.data.nr_message.data.half_row * 64 + i];
                        send_message.type = NS_GD_HALF_ROW;
                        network_send_add_message(&send_message);
                    } break;
                    default:
                        break;
                }
            } break;
            
            case PR_ADC_SAMPLES:
            {
                switch (astate) {
                    case AS_SCANNING: {
                        float ir_front_right = distance_lookup[recv_message.data.adc_samples.ir_front_right];
                        float ir_front_left = distance_lookup[recv_message.data.adc_samples.ir_front_left];
                        float ir_left = distance_lookup[recv_message.data.adc_samples.ir_left];
                        world_add_front_right_ir_sensor_reading(ir_front_right);
                        world_add_front_left_ir_sensor_reading(ir_front_left);
                        world_add_left_ir_sensor_reading(ir_left);
                    } break;
                    default:
                        break;
                }
            } break;
            
            default:
                break;
        }
    }
}
